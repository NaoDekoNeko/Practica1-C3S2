<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Ademar\OneDrive\Desktop\Practica1-C3S2\Sprint5\ReSOSgame\ReSOSgame\Juego.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Diagnostics.Contracts;
using static ReSOSGame.Tablero;

namespace ReSOSGame
{
    public abstract class Juego
    {
        public Tablero Tablero { get; }
        public ScoreValidator Validator;

        public int NumberOfEmptyCells
        {
            get
            {
                int numberOfEmptyCells = 0;
                for (int row = 0; row &lt; Tablero.Tamanio; ++row)
                {
                    for (int col = 0; col &lt; Tablero.Tamanio; ++col)
                    {
                        if (Tablero[row, col] == Cell.VACIA)
                        {
                            numberOfEmptyCells++;
                        }
                    }
                }
                return numberOfEmptyCells;
            }
        }
        public Juego(Tablero tablero)
        {
            Tablero = tablero;
            Validator = new ScoreValidator(tablero);
        }
        //Metodo que se encarga de realizar movimientos
        public abstract void MakeMove(int row,int col ,Cell ficha); // Funcion para realizar un movimiento
        
        //si es una celda v&#225;lida
        protected bool IsOnBoard(int row, int column)
        {
            return row &gt;= 0 &amp;&amp; row &lt; Tablero.Tamanio &amp;&amp; column &gt;= 0 &amp;&amp; column &lt; Tablero.Tamanio;
        }

        //si la celda se encuentra vacia
        protected bool IsEmpty(int row, int column)
        {
            return Tablero[row, column] == 0;
        }
    }
    public class JuegoSimple : Juego
    {
        private bool HasWon { get; set; }
        public JuegoSimple(Tablero tablero) : base(tablero)
        {
        }
        // Funcion que verifica si se ha ganado el juego simple
        // Funcion que actualiza el estado del juego Simple 
        protected virtual void FinalGameState() 
        {
            Contract.Requires(Tablero.EstadoDeJuego == GameState.JUGANDO, &quot;Un juego en curso&quot;);
            Contract.Ensures(Tablero.EstadoDeJuego == GameState.EMPATE &amp;&amp; Validator.FullBoard() &amp;&amp; !HasWon ||
                             Tablero.EstadoDeJuego == GameState.GANOAZUL &amp;&amp; Tablero.Turno == Jugador.JAZUL &amp;&amp; (Validator.FullBoard() || HasWon) ||
                             Tablero.EstadoDeJuego == GameState.GANOROJO &amp;&amp; Tablero.Turno == Jugador.JROJO &amp;&amp; (Validator.FullBoard() || HasWon),
                &quot;El estado de juego se ha actualizado correctamente despu&#233;s de finalizar el juego&quot;);


            //si el tablero est&#225; lleno sin ganador
            if (Validator.FullBoard() &amp;&amp; !HasWon)
            {
                Tablero.EstadoDeJuego = GameState.EMPATE;
            }
            //cuando hay un ganador cuando el tablero est&#233; lleno o no 
            else
            {
                Tablero.EstadoDeJuego = Tablero.Turno == Jugador.JAZUL ?
                    GameState.GANOAZUL : GameState.GANOROJO;  // Cambia el estado del tablero
            }
        }
        public override void MakeMove(int row, int column, Cell ficha)
        {
            Contract.Requires(!Validator.GameOver(), &quot;El juego debe estar en curso&quot;);
            Contract.Requires(IsOnBoard(row,column), &quot;El movimiento debe ser v&#225;lido&quot;);
            Contract.Requires(IsEmpty(row,column),&quot;La casilla debe estar vac&#237;a&quot;);
            Contract.Ensures(Tablero.ValidMove==true, &quot;Cuando el movimiento es v&#225;lido&quot;);
            Contract.Ensures(Tablero.ValidMove == Contract.OldValue(Tablero.ValidMove) || 
                             !Validator.GameOver(), &quot;El estado del juego no ha cambiado si el movimiento no es v&#225;lido&quot;);
            if (!Validator.GameOver()) // Si es el estado de juego es JUGANDO
            {
                // si el movimiento tiene coordenadas inv&#225;lidas o est&#225; ocupada la casilla, da return
                if (!IsOnBoard(row, column) || !IsEmpty(row,column))
                {
                    Tablero.ValidMove = false;
                    return;
                } 
                Tablero.ValidMove = true; // El atributo ValidMove es verdadero. 
                Tablero.Ficha = ficha; // rellena el atributo Ficha
                Tablero[row, column] = ficha; // rellena el grid del tablero con ficha
                // Cuando se ha hecho un punto
                if (Validator.HasOnePoint(row,column,Tablero.Ficha)) 
                {
                    HasWon = true;
                    FinalGameState(); // Actualiza el estado final del tablero
                    return;
                }
                // Cuando el tablero est&#233; lleno
                if (Validator.FullBoard())
                {
                    FinalGameState();
                    return;
                }
                if (Tablero.EstadoDeJuego == GameState.JUGANDO)  // Si el estado de juego es JUGANDO entonces ...
                {
                    Tablero.Turno = (Tablero.Turno == Jugador.JAZUL) ? Jugador.JROJO : Jugador.JAZUL; // Se hace el cambio de turno
                }
            }
            else
            {
                Tablero.ValidMove = false;
            }
        }

    }

    public class JuegoGeneral : Juego
    {
        // Atributos para tener los puntajes de cada jugador
        public int PuntajeAzul { get; private set; }
        public int PuntajeRojo { get; private set; }

        public JuegoGeneral(Tablero tablero) : base(tablero)
        {
        }
        
        // M&#233;todo que verifica si se ha ganado en un Juego General
        protected virtual void FinalGameState() // Calcula el estado final comparando los puntajes
        {
            Contract.Requires(Tablero.EstadoDeJuego == GameState.JUGANDO, &quot;Un juego en curso&quot;);
            Contract.Ensures(Tablero.EstadoDeJuego == GameState.GANOAZUL &amp;&amp; PuntajeAzul &gt; PuntajeRojo ||
                             Tablero.EstadoDeJuego == GameState.GANOROJO &amp;&amp; PuntajeRojo &gt; PuntajeAzul ||
                             Tablero.EstadoDeJuego == GameState.EMPATE &amp;&amp; PuntajeAzul == PuntajeRojo ||
                             Tablero.EstadoDeJuego == GameState.JUGANDO,
                &quot;El estado de juego se ha actualizado correctamente despu&#233;s de calcular el estado final&quot;);

            if (PuntajeAzul &gt; PuntajeRojo)
            {
                Tablero.EstadoDeJuego = GameState.GANOAZUL; // Establece que el azul ha ganado
            }
            else if (PuntajeAzul &lt; PuntajeRojo)
            {
                Tablero.EstadoDeJuego = GameState.GANOROJO; // Establece que el rojo ha ganado
            }
            else if (PuntajeRojo==PuntajeAzul)
            {
                Tablero.EstadoDeJuego = GameState.EMPATE; // Establece que ha habido un empate
            }
            //sino, el estado de juego es JUGANDO
        }

        public override void MakeMove(int row, int column, Cell ficha)
        {
            Contract.Requires(!Validator.GameOver(), &quot;El juego debe estar en curso&quot;);
            Contract.Requires(IsOnBoard(row, column), &quot;El movimiento debe ser v&#225;lido&quot;);
            Contract.Requires(IsEmpty(row, column), &quot;La casilla debe estar vac&#237;a&quot;);
            Contract.Requires(PuntajeAzul&gt;=0 &amp;&amp; PuntajeRojo&gt;=0, &quot;Los puntajes son positivos&quot;);
            Contract.Ensures(Tablero.ValidMove == true, &quot;Cuando el movimiento es v&#225;lido&quot;);
            Contract.Ensures(Tablero.ValidMove == Contract.OldValue(Tablero.ValidMove) ||
                             !Validator.GameOver(), &quot;El estado del juego no ha cambiado si el movimiento no es v&#225;lido&quot;);
            Contract.Ensures(Tablero.Turno == Jugador.JAZUL &amp;&amp; PuntajeAzul == Contract.OldValue(PuntajeAzul) + 1 ||
                             Tablero.Turno == Jugador.JROJO &amp;&amp; PuntajeRojo == Contract.OldValue(PuntajeRojo) + 1,
                &quot;El puntaje se ha actualizado correctamente despu&#233;s de obtener un punto&quot;);
            if (!Validator.GameOver())
            {
                // si el movimiento tiene coordenadas inv&#225;lidas o est&#225; ocupada la casilla, da return
                if (!IsOnBoard(row, column) || !IsEmpty(row,column))
                {
                    Tablero.ValidMove = false;
                    return;
                }
                Tablero.ValidMove = true;
                Tablero.Ficha = ficha;
                Tablero[row, column] = ficha;
                if (Validator.HasOnePoint(row, column, Tablero.Ficha)) // Si se ha obtenido un punto
                {
                    //en el turno del jugador JAZUL
                    if (Tablero.Turno == Jugador.JAZUL)
                    {
                        PuntajeAzul++; // Se agrega un punto al jugador Azul
                    } //en el turno del jugador JROJO
                    else                        {
                        PuntajeRojo++; // Se agrega un punto al jugador Rojo
                    }
                }
                if (Validator.FullBoard())
                {
                    FinalGameState(); // Actualiza el estado del juego cuando el tablero esta lleno
                }
                // Nota: esa funcion detiene el cambio de turno cuando ya se halla ganado o empatado
                if (Tablero.EstadoDeJuego == GameState.JUGANDO) // Si se sigue jugando
                {
                    Tablero.Turno = (Tablero.Turno == Jugador.JAZUL) ? Jugador.JROJO : Jugador.JAZUL; // Se cambia de turno al jugador contrario
                }
            }
            else
            {
                Tablero.ValidMove = false;
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[9,34,9,38,1],[15,13,15,14,1],[16,17,16,44,1],[17,22,17,33,1],[17,35,17,56,1],[17,58,17,63,1],[18,17,18,18,1],[19,26,19,37,1],[19,39,19,60,1],[19,62,19,67,1],[20,21,20,22,1],[21,25,21,61,1],[22,25,22,26,1],[23,29,23,50,1],[24,25,24,26,1],[25,21,25,22,1],[26,17,26,18,1],[27,17,27,43,1],[28,13,28,14,1],[30,9,30,38,1],[31,9,31,10,1],[32,13,32,31,1],[33,13,33,53,1],[34,9,34,10,1],[40,9,40,10,1],[41,13,41,97,1],[42,9,42,10,1],[46,9,46,10,1],[47,13,47,46,1],[48,9,48,10,1],[52,31,52,35,1],[52,36,52,40,1],[53,47,53,60,1],[54,9,54,10,1],[55,9,55,10,1],[59,9,59,10,1],[68,13,68,50,1],[69,13,69,14,1],[70,17,70,58,1],[71,13,71,14,1],[74,13,74,14,1],[75,17,76,61,1],[77,13,77,14,1],[78,9,78,10,1],[80,9,80,10,1],[87,13,87,39,1],[88,13,88,14,1],[90,17,90,69,1],[91,17,91,18,0],[92,21,92,47,0],[93,21,93,28,0],[95,17,95,42,1],[96,17,96,39,1],[97,17,97,46,1],[99,17,99,69,1],[100,17,100,18,1],[101,21,101,35,1],[102,21,102,38,1],[103,21,103,28,1],[106,17,106,43,1],[107,17,107,18,1],[108,21,108,38,1],[109,21,109,28,1],[111,17,111,64,1],[112,17,112,18,1],[113,21,113,102,1],[114,17,114,18,1],[115,13,115,14,1],[117,13,117,14,0],[118,17,118,43,0],[119,13,119,14,0],[120,9,120,10,1],[127,34,127,38,1],[127,39,127,51,1],[128,34,128,38,1],[128,39,128,51,1],[130,48,130,61,1],[131,9,131,10,1],[132,9,132,10,1],[136,9,136,10,1],[144,13,144,43,1],[145,13,145,14,1],[146,17,146,60,1],[147,13,147,14,1],[148,18,148,48,1],[149,13,149,14,1],[150,17,150,60,1],[151,13,151,14,1],[152,18,152,47,1],[153,13,153,14,1],[154,17,154,58,1],[155,13,155,14,1],[157,9,157,10,1],[160,9,160,10,1],[171,13,171,39,1],[172,13,172,14,1],[174,17,174,69,1],[175,17,175,18,0],[176,21,176,47,0],[177,21,177,28,0],[179,17,179,42,1],[180,17,180,39,1],[181,17,181,46,1],[182,17,182,71,1],[183,17,183,18,1],[185,21,185,56,1],[186,21,186,22,1],[187,25,187,39,1],[188,21,188,22,1],[189,49,189,50,1],[190,25,190,39,1],[191,21,191,22,1],[192,17,192,18,1],[193,17,193,43,1],[194,17,194,18,1],[195,21,195,38,1],[196,17,196,18,1],[198,17,198,64,1],[199,17,199,18,1],[200,21,200,102,1],[201,17,201,18,1],[202,13,202,14,1],[204,13,204,14,0],[205,17,205,43,0],[206,13,206,14,0],[207,9,207,10,1]]);
    </script>
  </body>
</html>